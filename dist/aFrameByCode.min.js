// name: aFrameByCode
// author: Faace Yu
// version: 1.1.1
// github: https://github.com/faace/aFrameByCode

(function(q){AFRAME.$=$=document.querySelector.bind(document);AFRAME.$$=$$=document.querySelectorAll.bind(document);var w=function(x,g,z){var y=0;return function(){z&&z(Math.min(x,y+1),x);if(++y>=x){x=null;if(z){z=null}if(g){g();g=null}}}};var n=function(){var C;if(typeof arguments[0]=="string"){C={tag:arguments[0]};if(typeof arguments[1]=="string"){C.attributes=arguments[2]||{};C.attributes.src=arguments[1]}else{if(arguments[1].attributes){C.attributes=arguments[1].attributes;C.children=arguments[1].children}else{if(arguments[1].children){C.attributes={};C.children=arguments[1].children}else{C.attributes=arguments[1]||{}}}}}else{C=arguments[0]}var x={attributes:{}};if(true){var g=C.tag||"a-entity";var D="";var z=g.split("#");if(z.length>1){g=z[0];D=z[1]}x.tag=g;x.attributes.id=D}for(var B in C.attributes){x.attributes[B]=C.attributes[B]}if(C.children){var A=C.children;x.children=[];if(Array.isArray(A)){for(var y=0;y<A.length;y++){x.children.push(n(A[y]))}}else{for(var y in A){x.children.push(n(y,A[y]))}}}return x};var h=function(x){var A=document.createElement("div");A.innerHTML=(x||"").replace(/\n/g,"").replace(/\s+/g," ").replace(/^\s*/,"").replace(/\s*$/,"").replace(/>\s*</g,"><");var y=function(G,H){var C={tag:G.localName};H.push(C);if(G.attributes.length>0){var B=C.attributes={};for(var D=0;D<G.attributes.length;D++){B[G.attributes[D].name]=G.attributes[D].value}}if(G.children.length>0){var F=C.children=[];for(var E=0;E<G.children.length;E++){y(G.children[E],F)}}};var z=[];try{y(A,z)}catch(g){console.log("err html",g)}return(z[0]&&z[0].children)||[]};var a=function(){var g=n.apply(n,arguments);return this.createAnEntity(g,this)};var u=function(A,x){if(!A){return}var z;if(Array.isArray(A)){for(var y=0;y<A.length;y++){z=this.createAnEntity(A[y],this);x&&x(z)}}else{if(typeof A=="string"){var B=h(A);u.bind(this)(B,x)}else{for(var g in A){z=this.addAnEntity(g,A[g]);x&&x(z)}}}};var t=function(z,y){if(typeof y=="undefined"){y=this}var z=n(z);var x=document.createElement(z.tag);if(y){y.appendChild(x)}r(x);o(x,z.attributes);if(z.children){for(var g=0;g<z.children.length;g++){this.createAnEntity(z.children[g],x)}}return x};var d=function(x){var g=AFRAME.$(x);g.parentNode.removeChild(g)};var c=function(y){var x=$$(y);for(var g=0;g<x.length;g++){x[g].parentNode&&x[g].parentNode.removeChild(x[g])}};var p=function(){this.onRemove&&this.onRemove();delete this.onRemove;this.parentNode&&this.parentNode.removeChild(this)};var o=function(y,g){if(typeof g=="function"){g=g()}if(g){for(var x in g){y.setAttribute(x,g[x]||"")}}};var b=function(y){if(!y||!y.conf){return}if(!this.hasLoaded){return this.addEventListener("loaded",function(){b.bind(this)(y)})}var x=this.sceneEl&&this.sceneEl.systems["afbcAnim"];if(!x){return setTimeout(function(){b.bind(this)(y)},100)}var g=Date.now()+Math.round(10000*Math.random());var z=y.conf;z["currRepeat"+g]=0;AnimRealRun.bind(this)(z,null,g)};var m=function(){if(!this.hasLoaded){return this.addEventListener("loaded",function(){m.bind(this)()})}var g=this.sceneEl&&this.sceneEl.systems["afbcAnim"];if(!g){return setTimeout(function(){m.bind(this)()},100)}g.pause(this)};var j=function(){if(!this.hasLoaded){return this.addEventListener("loaded",function(){j.bind(this)()})}var g=this.sceneEl&&this.sceneEl.systems["afbcAnim"];if(!g){return setTimeout(function(){j.bind(this)()},100)}g.resume(this)};var r=function(g){g.addAnEntity=a.bind(g);g.addEntities=u.bind(g);g.createAnEntity=t.bind(g);g.removeAnEntity=d.bind(g);g.removeEntities=c.bind(g);g.removeMe=p.bind(g);g.setAttributes=function(x){o(g,x)};g.animRun=b.bind(g);g.animPause=m.bind(g);g.animResume=j.bind(g);return g};AFRAME.extScenes={};AFRAME.extCurrScene=null;AFRAME.createAScene=function(g){AFRAME.extScenes[g.id]=g;return this};AFRAME.loadScene=function(g){if(this.extCurrScene){this.extCurrScene.removeMe()}var y=document.createElement("a-scene");r(y);var A=this.extScenes[g];if(!A){return console.error("No scene: "+g)}document.body.appendChild(y);if(A.onRemove){y.onRemove=A.onRemove.bind(A)}this.extCurrScene=y;var x=A.attributes||{};if(typeof x=="function"){x=x()}x.id=g;o(y,x);y.addAnEntity("a-assets",{id:"assets"});y.assets=new f("#assets");var z=A.assets||{};if(typeof z=="function"){z=z()}y.assets.addList(z);y.addEntities(A.children);if(A.onInit){A.onInit.bind(A)(y)}y.assets.load(function(){var B=function(){A.onLoaded&&A.onLoaded.bind(A)(y)}.bind(this);if(y.hasLoaded){B()}else{y.addEventListener("loaded",B)}},A.onLoading&&A.onLoading.bind(A))};var s=function(x,g,z){if(!z){return}var y=function(){x.removeEventListener(x._eventName,y);delete x._eventName;var A=z;z=null;A()};if(g=="script"){return x.onload=function(){delete x.onload;var A=z;z=null;A()}}if(g=="img"){x._eventName="load"}else{if(g=="audio"||g=="video"){x._eventName="loadeddata"}else{x._eventName="loaded"}}x.addEventListener(x._eventName,y)};var f=function(g){this.id=g;this.list={}};f.prototype.add=function(){var z=n.apply(n,arguments);if(!z.attributes.crossorigin){z.attributes.crossorigin="anonymous"}var g=z.tag;var x=$(this.id);var y=x.addAnEntity(z);this.list[g]=y;return this};f.prototype.addList=function(y){if(!y){return}if(Array.isArray(y)){for(var x=0;x<y.length;x++){this.add(y[x])}}else{for(var g in y){this.add(g,y[g])}}return this};f.prototype.load=function(x,C){var B=this.list;this.list={};var y=0;for(var A in B){y++}if(y<1){return x&&x()}var z=w(y,function(){x&&x()},C);for(var g in B){s(B[g],g,z)}return this};AFRAME.registerComponent("f-click-to-scene",{schema:{scene:{type:"string"}},init:function(){this.el.addEventListener("click",this.loadScene.bind(this))},loadScene:function(){AFRAME.loadScene(this.data.scene)},remove:function(){this.el.removeEventListener("click",this.loadScene.bind(this))}});document.addEventListener("DOMContentLoaded",function(){document.removeEventListener("DOMContentLoaded",arguments.callee,false);var g=document.body.getAttribute("scene");if(g){AFRAME.loadScene(g)}},false);AFRAME.registerSystem("afbcAnim",{init:function(){this.list=[]},addAnim:function(g,x,y){this.list.push({idx:g,anim:x,target:y})},removeAnim:function(g){for(var x=0;x<this.list.length;x++){if(this.list[x].idx==g){this.list.splice(x,1)}}},removeAnimByTarget:function(g){for(i=this.list.length-1;i>-1;i--){if(this.list[i].target==g){this.list.splice(i,1)}}},pause:function(g){g.isAnimPause=true;for(i=this.list.length-1;i>-1;i--){if(this.list[i].target==g){this.list[i].anim.pause()}}},resume:function(g){g.isAnimPause=false;for(i=this.list.length-1;i>-1;i--){if(this.list[i].target==g){this.list[i].anim.play()}}},tick:(function(){var g;return function(x){if(this.list.length){for(g=this.list.length-1;g>-1;g--){if(this.list[g].target.isAnimPause){return}this.list[g].anim.tick(x)}}}})(),});var v=function(){this.conf=null};AFRAME.anim=function(){return new v()};AnimRealRun=function(D,z,E){if(D._repeat>-1&&D["currRepeat"+E]>=D._repeat){delete D["currRepeat"+E];delete D["_from"+E];delete D["_to"+E];return z&&z()}var C=AnimRealRun.bind(this);var g=this.sceneEl.systems["afbcAnim"];D["currRepeat"+E]++;switch(D.type){case"sequence":if(typeof D["sequenceIdx"+E]=="undefined"){D["sequenceIdx"+E]=0}var B=D._sequence[D["sequenceIdx"+E]];D["sequenceIdx"+E]++;if(B){D["currRepeat"+E]--;B["currRepeat"+E]=0;C(B,function(){C(D,z,E)},E)}else{D["sequenceIdx"+E]=0;C(D,z,E)}break;case"spawn":if(D._spawn.length<1){return C(D,z,E)}var I=w(D._spawn.length,function(){C(D,z,E)});for(var A=0;A<D._spawn.length;A++){D._spawn[A]["currRepeat"+E]=0;C(D._spawn[A],I,E)}break;case"cb":D.cb&&D.cb.bind(D.taget)();C(D,z,E);break;case"delay":setTimeout(function(){C(D,z,E)},D._delay);break;case"fadeOut":case"fadeIn":case"fadeTo":var H=Date.now()+Math.round(10000*Math.random());var x=D.getConfig();var y=(this.object3DMap&&this.object3DMap.mesh&&this.object3DMap.mesh.material)||(this.components&&this.components.material&&this.components.material.material);if(!y){return z&&z()}if(Array.isArray(y)){y.forEach(function(K){K.transparent=true})}else{y.transparent=true}var G,F;if(D._reverse&&D["currRepeat"+E]%2==0){F=D["_from"+E];G=D["_to"+E]}else{G=D.from;F=D.to;if(typeof G=="undefined"){G=Array.isArray(y)?y[0].opacity:y.opacity}}x.opacity=[G,F];D["_from"+E]=G;D["_to"+E]=F;x.targets=y;x.complete=function(){g.removeAnim(H);C(D,z,E)};g.addAnim(H,AFRAME.ANIME(x),this);break;case"move":case"moveTo":case"moveBy":var H=Date.now()+Math.round(10000*Math.random());var x=D.getConfig();var J=this.object3D&&this.object3D.position;if(!J){return z&&z()}var G,F;if(D._reverse&&D["currRepeat"+E]%2==0){F=D["_from"+E];G=D["_to"+E]}else{G=D.from&&new THREE.Vector3().copy(D.from);F=D.to&&new THREE.Vector3().copy(D.to);if(!G){G=new THREE.Vector3().copy(J)}if(!F){F=new THREE.Vector3().copy(J).add(D.by)}}x.x=[G.x,F.x];x.y=[G.y,F.y];x.z=[G.z,F.z];D["_from"+E]=G;D["_to"+E]=F;x.targets=J;x.complete=function(){g.removeAnim(H);C(D,z,E)};g.addAnim(H,AFRAME.ANIME(x),this);break;case"scale":case"scaleTo":case"scaleBy":var H=Date.now()+Math.round(10000*Math.random());var x=D.getConfig();var J=this.object3D&&this.object3D.scale;if(!J){return z&&z()}var G,F;if(D._reverse&&D["currRepeat"+E]%2==0){F=D["_from"+E];G=D["_to"+E]}else{G=D.from&&new THREE.Vector3().copy(D.from);F=D.to&&new THREE.Vector3().copy(D.to);if(!G){G=new THREE.Vector3().copy(J)}if(!F){F=new THREE.Vector3().copy(J).add(D.by)}}x.x=[G.x,F.x];x.y=[G.y,F.y];x.z=[G.z,F.z];D["_from"+E]=G;D["_to"+E]=F;x.targets=J;x.complete=function(){g.removeAnim(H);C(D,z,E)};g.addAnim(H,AFRAME.ANIME(x),this);break;case"rotation":case"rotationTo":case"rotationBy":var H=Date.now()+Math.round(10000*Math.random());var x=D.getConfig();var J=this.object3D&&this.object3D.rotation;if(!J){return z&&z()}var G,F;if(D._reverse&&D["currRepeat"+E]%2==0){F=D["_from"+E];G=D["_to"+E]}else{G=D.from&&new THREE.Vector3().copy(D.from);F=D.to&&new THREE.Vector3().copy(D.to);if(!G){G=new THREE.Vector3().copy(J)}if(!F){F=new THREE.Vector3().copy(J).add(D.by)}}x.x=[G.x,F.x];x.y=[G.y,F.y];x.z=[G.z,F.z];D["_from"+E]=G;D["_to"+E]=F;x.targets=J;x.complete=function(){g.removeAnim(H);C(D,z,E)};g.addAnim(H,AFRAME.ANIME(x),this);break;case"color":case"colorTo":case"colorBy":var H=Date.now()+Math.round(10000*Math.random());var x=D.getConfig();var y=(this.object3DMap&&this.object3DMap.mesh&&this.object3DMap.mesh.material)||(this.components&&this.components.material&&this.components.material.material);if(!y){return z&&z()}var J=[];if(Array.isArray(y)){y.forEach(function(K){J.push(K.color)})}else{J.push(y.color)}var G,F;if(D._reverse&&D["currRepeat"+E]%2==0){F=D["_from"+E];G=D["_to"+E]}else{G=D.from&&new THREE.Color().copy(D.from);F=D.to&&new THREE.Color().copy(D.to);if(!G){G=new THREE.Color().copy(J[0])}if(!F){F=new THREE.Color().copy(J[0]).add(D.by)}}x.r=[G.r,F.r];x.g=[G.g,F.g];x.b=[G.b,F.b];D["_from"+E]=G;D["_to"+E]=F;x.targets=J;x.complete=function(){g.removeAnim(H);C(D,z,E)};g.addAnim(H,AFRAME.ANIME(x),this);break}};v.prototype.fadeOut=function(g){return this.conf=new k().setDuration(g).setFrom(1).setTo(0).setType("fadeOut")};v.prototype.fadeIn=function(g){return this.conf=new k().setDuration(g).setFrom(0).setTo(1).setType("fadeIn")};v.prototype.fadeTo=function(x,g){return this.conf=new k().setDuration(x).setTo(g).setType("fadeTo")};v.prototype.move=function(g,y,x){return this.conf=new k().setDuration(g).setFrom(y).setTo(x).setType("move")};v.prototype.moveTo=function(g,x){return this.conf=new k().setDuration(g).setTo(x).setType("moveTo")};v.prototype.moveBy=function(g,x){return this.conf=new k().setDuration(g).setBy(x).setType("moveBy")};v.prototype.scale=function(g,y,x){return this.conf=new k().setDuration(g).setFrom(y).setTo(x).setType("scale")};v.prototype.scaleTo=function(g,x){return this.conf=new k().setDuration(g).setTo(x).setType("scaleTo")};v.prototype.scaleBy=function(g,x){return this.conf=new k().setDuration(g).setBy(x).setType("scaleBy")};var l=Math.PI/180;v.prototype.rotation=function(g,y,x){y={x:y.x*l,y:y.y*l,z:y.z*l};x={x:x.x*l,y:x.y*l,z:x.z*l};return this.conf=new k().setDuration(g).setFrom(y).setTo(x).setType("rotation")};v.prototype.rotationTo=function(g,x){x={x:x.x*l,y:x.y*l,z:x.z*l};return this.conf=new k().setDuration(g).setTo(x).setType("rotationTo")};v.prototype.rotationBy=function(g,x){x={x:x.x*l,y:x.y*l,z:x.z*l};return this.conf=new k().setDuration(g).setBy(x).setType("rotationBy")};var e=function(g){if(typeof g!="object"){return new THREE.Color(g)}return{r:g.r/255,g:g.g/255,b:g.b/255}};v.prototype.color=function(g,y,x){y=e(y);x=e(x);return this.conf=new k().setDuration(g).setFrom(y).setTo(x).setType("color")};v.prototype.colorTo=function(g,x){x=e(x);return this.conf=new k().setDuration(g).setTo(x).setType("colorTo")};v.prototype.colorBy=function(g,x){x=e(x);return this.conf=new k().setDuration(g).setBy(x).setType("colorBy")};v.prototype.cb=function(g,x){return this.conf=new k().setCb(g,x).setType("cb")};v.prototype.delay=function(g){return this.conf=new k().delay(g).setType("delay")};v.prototype.sequence=function(){return this.conf=new k().sequence(arguments).setType("sequence")};v.prototype.spawn=function(){return this.conf=new k().spawn(arguments).setType("spawn")};var k=function(){this._repeat=1};k.prototype.getConfig=function(){var g={autoplay:false,direction:"normal",duration:1000,easing:"linear",elasticity:400,loop:0,round:false,};for(var x in g){if(typeof this["_"+x]!="undefined"){g[x]=this["_"+x]}}return g};k.prototype.setType=function(g){this.type=g;return this};k.prototype.setDuration=function(g){this._duration=parseInt(g);return this};k.prototype.setFrom=function(g){this.from=g;return this};k.prototype.setTo=function(g){this.to=g;return this};k.prototype.setBy=function(g){this.by=g;return this};k.prototype.setCb=function(g,x){this.cb=g;this.taget=x;return this};k.prototype.delay=function(g){this._delay=g;return this};k.prototype.reverse=function(g){this._reverse=true;return this};k.prototype.sequence=function(y){var g=this._sequence=[];for(var x=0;x<y.length;x++){g.push(y[x])}return this};k.prototype.spawn=function(y){var g=this._spawn=[];for(var x=0;x<y.length;x++){g.push(y[x])}return this};k.prototype.repeat=function(g){this._repeat=g;return this};k.prototype.repeatForever=function(){this._repeat=-1;return this};["linear","easeInQuad","easeOutQuad","easeInOutQuad","easeInCubic","easeOutCubic","easeInOutCubic","easeInQuart","easeOutQuart","easeInOutQuart","easeInQuint","easeOutQuint","easeInOutQuint","easeInSine","easeOutSine","easeInOutSine","easeInExpo","easeOutExpo","easeInOutExpo","easeInCirc","easeOutCirc","easeInOutCirc","easeInBack","easeOutBack","easeInOutBack","easeInElastic","easeOutElastic","easeInOutElastic"].forEach(function(g){k.prototype[g]=function(){this._easing=g;return this}})})(window);