// name: aFrameByCode
// author: Faace Yu
// version: 1.1.0
// github: https://github.com/faace/aFrameByCode

(function(l){AFRAME.$=$=document.querySelector.bind(document);AFRAME.$$=$$=document.querySelectorAll.bind(document);var f=function(s,g,u){var t=0;return function(){u&&u(Math.min(s,t+1),s);if(++t>=s){s=null;if(u){u=null}if(g){g();g=null}}}};var p=function(){var x;if(typeof arguments[0]=="string"){x={tag:arguments[0]};if(typeof arguments[1]=="string"){x.attributes=arguments[2]||{};x.attributes.src=arguments[1]}else{if(arguments[1].attributes){x.attributes=arguments[1].attributes;x.children=arguments[1].children}else{if(arguments[1].children){x.attributes={};x.children=arguments[1].children}else{x.attributes=arguments[1]||{}}}}}else{x=arguments[0]}var s={attributes:{}};if(true){var g=x.tag||"a-entity";var y="";var u=g.split("#");if(u.length>1){g=u[0];y=u[1]}s.tag=g;s.attributes.id=y}for(var w in x.attributes){s.attributes[w]=x.attributes[w]}if(x.children){var v=x.children;s.children=[];if(Array.isArray(v)){for(var t=0;t<v.length;t++){s.children.push(p(v[t]))}}else{for(var t in v){s.children.push(p(t,v[t]))}}}return s};var h=function(s){var v=document.createElement("div");v.innerHTML=(s||"").replace(/\n/g,"").replace(/\s+/g," ").replace(/^\s*/,"").replace(/\s*$/,"").replace(/>\s*</g,"><");var t=function(B,C){var x={tag:B.localName};C.push(x);if(B.attributes.length>0){var w=x.attributes={};for(var y=0;y<B.attributes.length;y++){w[B.attributes[y].name]=B.attributes[y].value}}if(B.children.length>0){var A=x.children=[];for(var z=0;z<B.children.length;z++){t(B.children[z],A)}}};var u=[];try{t(v,u)}catch(g){console.log("err html",g)}return(u[0]&&u[0].children)||[]};var k=function(){var g=p.apply(p,arguments);return this.createAnEntity(g,this)};var d=function(v,s){if(!v){return}var u;if(Array.isArray(v)){for(var t=0;t<v.length;t++){u=this.createAnEntity(v[t],this);s&&s(u)}}else{if(typeof v=="string"){var w=h(v);d.bind(this)(w,s)}else{for(var g in v){u=this.addAnEntity(g,v[g]);s&&s(u)}}}};var n=function(u,t){if(typeof t=="undefined"){t=this}var u=p(u);var s=document.createElement(u.tag);if(t){t.appendChild(s)}i(s);c(s,u.attributes);if(u.children){for(var g=0;g<u.children.length;g++){this.createAnEntity(u.children[g],s)}}return s};var b=function(s){var g=AFRAME.$(s);g.parentNode.removeChild(g)};var o=function(t){var s=$$(t);for(var g=0;g<s.length;g++){s[g].parentNode&&s[g].parentNode.removeChild(s[g])}};var a=function(){this.onRemove&&this.onRemove();delete this.onRemove;this.parentNode&&this.parentNode.removeChild(this)};var c=function(t,g){if(typeof g=="function"){g=g()}if(g){for(var s in g){t.setAttribute(s,g[s]||"")}}};var i=function(g){g.addAnEntity=k.bind(g);g.addEntities=d.bind(g);g.createAnEntity=n.bind(g);g.removeAnEntity=b.bind(g);g.removeEntities=o.bind(g);g.removeMe=a.bind(g);g.setAttributes=function(s){c(g,s)};g.run=m.run.bind(g);return g};AFRAME.extScenes={};AFRAME.extCurrScene=null;AFRAME.createAScene=function(g){AFRAME.extScenes[g.id]=g;return this};AFRAME.loadScene=function(g){if(this.extCurrScene){this.extCurrScene.removeMe()}var t=document.createElement("a-scene");i(t);var v=this.extScenes[g];if(!v){return console.error("No scene: "+g)}document.body.appendChild(t);if(v.onRemove){t.onRemove=v.onRemove.bind(v)}this.extCurrScene=t;var s=v.attributes||{};if(typeof s=="function"){s=s()}s.id=g;c(t,s);t.addAnEntity("a-assets",{id:"assets"});t.assets=new j("#assets");var u=v.assets||{};if(typeof u=="function"){u=u()}t.assets.addList(u);t.addEntities(v.children);if(v.onInit){v.onInit.bind(v)(t)}t.assets.load(function(){var w=function(){v.onLoaded&&v.onLoaded.bind(v)(t)}.bind(this);if(t.hasLoaded){w()}else{t.addEventListener("loaded",w)}},v.onLoading&&v.onLoading.bind(v))};var e=function(s,g,u){if(!u){return}var t=function(){s.removeEventListener(s._eventName,t);delete s._eventName;var v=u;u=null;v()};if(g=="script"){return s.onload=function(){delete s.onload;var v=u;u=null;v()}}if(g=="img"){s._eventName="load"}else{if(g=="audio"||g=="video"){s._eventName="loadeddata"}else{s._eventName="loaded"}}s.addEventListener(s._eventName,t)};var j=function(g){this.id=g;this.list={}};j.prototype.add=function(){var u=p.apply(p,arguments);if(!u.attributes.crossorigin){u.attributes.crossorigin="anonymous"}var g=u.tag;var s=$(this.id);var t=s.addAnEntity(u);this.list[g]=t;return this};j.prototype.addList=function(t){if(!t){return}if(Array.isArray(t)){for(var s=0;s<t.length;s++){this.add(t[s])}}else{for(var g in t){this.add(g,t[g])}}return this};j.prototype.load=function(s,x){var w=this.list;this.list={};var t=0;for(var v in w){t++}if(t<1){return s&&s()}var u=f(t,function(){s&&s()},x);for(var g in w){e(w[g],g,u)}return this};AFRAME.registerComponent("f-click-to-scene",{schema:{scene:{type:"string"}},init:function(){this.el.addEventListener("click",this.loadScene.bind(this))},loadScene:function(){AFRAME.loadScene(this.data.scene)},remove:function(){this.el.removeEventListener("click",this.loadScene.bind(this))}});document.addEventListener("DOMContentLoaded",function(){document.removeEventListener("DOMContentLoaded",arguments.callee,false);var g=document.body.getAttribute("scene");if(g){AFRAME.loadScene(g)}},false);AFRAME.registerSystem("afbcAnim",{init:function(){this.list=[]},addAnim:function(g,s){this.list.push({idx:g,anim:s})},removeAnim:function(g){for(var s=0;s<this.list.length;s++){if(this.list[s].idx==g){this.list.splice(s,1)}}},tick:(function(){var s,g;return function(t){if(this.list.length){for(s=this.list.length-1;s>-1;s--){this.list[s].anim.tick(t)}}}})(),});var m=function(){this.conf=null};AFRAME.anim=function(){return new m()};AnimRealRun=function(z,v){if(z.repeat>-1&&z.currRepeat>=z.repeat){z.currRepeat=0;return v&&v()}var y=AnimRealRun.bind(this);var g=this.sceneEl.systems["afbcAnim"];z.currRepeat++;switch(z.type){case"sequence":if(typeof z.sequenceIdx=="undefined"){z.sequenceIdx=0}var x=z.sequence[z.sequenceIdx];z.sequenceIdx++;if(x){z.currRepeat--;x.currRepeat=0;y(x,function(){y(z,v)})}else{z.sequenceIdx=0;y(z,v)}break;case"spawn":var D=f(z.spawn.length,function(){y(z,v)});for(var w=0;w<z.spawn.length;w++){z.spawn[w].currRepeat=0;y(z.spawn[w],D)}break;case"cb":z.currRepeat=0;z.cb&&z.cb.bind(z.taget)();v&&v();break;case"delay":setTimeout(function(){z.currRepeat=0;v&&v()},z.delay);break;case"fadeOut":case"fadeIn":case"fadeTo":var C=Date.now()+Math.round(10000*Math.random());var s=z.getConfig();var u=(this.object3DMap&&this.object3DMap.mesh&&this.object3DMap.mesh.material)||(this.components&&this.components.material&&this.components.material.material);if(!u){return v&&v()}if(Array.isArray(u)){u.forEach(function(t){t.transparent=true})}else{u.transparent=true}var B=z.from,A=z.to;if(typeof B=="undefined"){B=Array.isArray(u)?u[0].opacity:u.opacity}s.opacity=[B,A];s.targets=u;s.complete=function(){g.removeAnim(C);z.currRepeat=0;v&&v()};g.addAnim(C,AFRAME.ANIME(s));break;case"move":case"moveTo":case"moveBy":var C=Date.now()+Math.round(10000*Math.random());var s=z.getConfig();var E=this.object3D&&this.object3D.position;if(!E){return v&&v()}var B=z.from&&new THREE.Vector3().copy(z.from),A=z.to&&new THREE.Vector3().copy(z.to);if(!B){B=new THREE.Vector3().copy(E)}if(!A){A=new THREE.Vector3().copy(E).add(z.by)}s.x=[B.x,A.x];s.y=[B.y,A.y];s.z=[B.z,A.z];s.targets=E;s.complete=function(){g.removeAnim(C);z.currRepeat=0;v&&v()};g.addAnim(C,AFRAME.ANIME(s));break;case"scale":case"scaleTo":case"scaleBy":var C=Date.now()+Math.round(10000*Math.random());var s=z.getConfig();var E=this.object3D&&this.object3D.scale;if(!E){return v&&v()}var B=z.from&&new THREE.Vector3().copy(z.from),A=z.to&&new THREE.Vector3().copy(z.to);if(!B){B=new THREE.Vector3().copy(E)}if(!A){A=new THREE.Vector3().copy(E).add(z.by)}s.x=[B.x,A.x];s.y=[B.y,A.y];s.z=[B.z,A.z];s.targets=E;s.complete=function(){g.removeAnim(C);z.currRepeat=0;v&&v()};g.addAnim(C,AFRAME.ANIME(s));break;case"rotation":case"rotationTo":case"rotationBy":var C=Date.now()+Math.round(10000*Math.random());var s=z.getConfig();var E=this.object3D&&this.object3D.rotation;if(!E){return v&&v()}var B=z.from&&new THREE.Vector3().copy(z.from),A=z.to&&new THREE.Vector3().copy(z.to);if(!B){B=new THREE.Vector3().copy(E)}if(!A){A=new THREE.Vector3().copy(E).add(z.by)}s.x=[B.x,A.x];s.y=[B.y,A.y];s.z=[B.z,A.z];s.targets=E;s.complete=function(){g.removeAnim(C);z.currRepeat=0;v&&v()};g.addAnim(C,AFRAME.ANIME(s));break}};m.run=function(g){var s=g.conf;s.currRepeat=0;AnimRealRun.bind(this)(s)};m.prototype.fadeOut=function(g){return this.conf=new r().setDuration(g).setFrom(1).setTo(0).setType("fadeOut")};m.prototype.fadeIn=function(g){return this.conf=new r().setDuration(g).setFrom(0).setTo(1).setType("fadeIn")};m.prototype.move=function(g,t,s){return this.conf=new r().setDuration(g).setFrom(t).setTo(s).setType("move")};m.prototype.moveTo=function(g,s){return this.conf=new r().setDuration(g).setTo(s).setType("moveTo")};m.prototype.moveBy=function(g,s){return this.conf=new r().setDuration(g).setBy(s).setType("moveBy")};m.prototype.scale=function(g,t,s){return this.conf=new r().setDuration(g).setFrom(t).setTo(s).setType("scale")};m.prototype.scaleTo=function(g,s){return this.conf=new r().setDuration(g).setTo(s).setType("scaleTo")};m.prototype.scaleBy=function(g,s){return this.conf=new r().setDuration(g).setBy(s).setType("scaleBy")};var q=Math.PI/180;m.prototype.rotation=function(g,t,s){t={x:t.x*q,y:t.y*q,z:t.z*q};s={x:s.x*q,y:s.y*q,z:s.z*q};return this.conf=new r().setDuration(g).setFrom(t).setTo(s).setType("rotation")};m.prototype.rotationTo=function(g,s){s={x:s.x*q,y:s.y*q,z:s.z*q};return this.conf=new r().setDuration(g).setTo(s).setType("rotationTo")};m.prototype.rotationBy=function(g,s){s={x:s.x*q,y:s.y*q,z:s.z*q};return this.conf=new r().setDuration(g).setBy(s).setType("rotationBy")};m.prototype.cb=function(g,s){return this.conf=new r().setCb(g,s).setType("cb")};m.prototype.delay=function(g){return this.conf=new r().setDelay(g).setType("delay")};m.prototype.sequence=function(){return this.conf=new r().setSequence(arguments).setType("sequence")};m.prototype.spawn=function(){return this.conf=new r().setSpawn(arguments).setType("spawn")};m.prototype.tick=function(g){if(!this.isPlaying){return}this.time+=g;this.animation.tick(this.time)};var r=function(g){this.repeat=1};r.prototype.getConfig=function(){var g={autoplay:false,direction:"normal",duration:1000,easing:"easeInOutQuad",elasticity:400,loop:0,round:false,};for(var s in g){if(typeof this[s]!="undefined"){g[s]=this[s]}}return g};r.prototype.setType=function(g){this.type=g;return this};r.prototype.setDuration=function(g){this.duration=parseInt(g);return this};r.prototype.setFrom=function(g){this.from=g;return this};r.prototype.setTo=function(g){this.to=g;return this};r.prototype.setBy=function(g){this.by=g;return this};r.prototype.setCb=function(g,s){this.cb=g;this.taget=s;return this};r.prototype.setDelay=function(g){this.delay=g;return this};r.prototype.setSequence=function(s){var t=this.sequence=[];for(var g=0;g<s.length;g++){t.push(s[g])}return this};r.prototype.setSpawn=function(t){var s=this.spawn=[];for(var g=0;g<t.length;g++){s.push(t[g])}return this};r.prototype.setRepeat=function(g){this.repeat=g;return this};r.prototype.setRepeatForever=function(){this.repeat=-1;return this}})(window);