// name: aFrameByCode
// author: Faace Yu
// version: 1.1.2
// github: https://github.com/faace/aFrameByCode

(function(q){AFRAME.$=$=document.querySelector.bind(document);AFRAME.$$=$$=document.querySelectorAll.bind(document);var x=function(y,g,A){var z=0;return function(){A&&A(Math.min(y,z+1),y);if(++z>=y){y=null;if(A){A=null}if(g){g();g=null}}}};var n=function(){var D;if(typeof arguments[0]=="string"){D={tag:arguments[0]};if(typeof arguments[1]=="string"){D.attributes=arguments[2]||{};D.attributes.src=arguments[1]}else{if(arguments[1].attributes){D.attributes=arguments[1].attributes;D.children=arguments[1].children}else{if(arguments[1].children){D.attributes={};D.children=arguments[1].children}else{D.attributes=arguments[1]||{}}}}}else{D=arguments[0]}var y={attributes:{}};if(true){var g=D.tag||"a-entity";var E="";var A=g.split("#");if(A.length>1){g=A[0];E=A[1]}y.tag=g;y.attributes.id=E}for(var C in D.attributes){y.attributes[C]=D.attributes[C]}if(D.children){var B=D.children;y.children=[];if(Array.isArray(B)){for(var z=0;z<B.length;z++){y.children.push(n(B[z]))}}else{for(var z in B){y.children.push(n(z,B[z]))}}}return y};var h=function(y){var B=document.createElement("div");B.innerHTML=(y||"").replace(/\n/g,"").replace(/\s+/g," ").replace(/^\s*/,"").replace(/\s*$/,"").replace(/>\s*</g,"><");var z=function(H,I){var D={tag:H.localName};I.push(D);if(H.attributes.length>0){var C=D.attributes={};for(var E=0;E<H.attributes.length;E++){C[H.attributes[E].name]=H.attributes[E].value}}if(H.children.length>0){var G=D.children=[];for(var F=0;F<H.children.length;F++){z(H.children[F],G)}}};var A=[];try{z(B,A)}catch(g){console.log("err html",g)}return(A[0]&&A[0].children)||[]};var a=function(){var g=n.apply(n,arguments);return this.createAnEntity(g,this)};var u=function(B,y){if(!B){return}var A;if(Array.isArray(B)){for(var z=0;z<B.length;z++){A=this.createAnEntity(B[z],this);y&&y(A)}}else{if(typeof B=="string"){var C=h(B);u.bind(this)(C,y)}else{for(var g in B){A=this.addAnEntity(g,B[g]);y&&y(A)}}}};var t=function(A,z){if(typeof z=="undefined"){z=this}var A=n(A);var y=document.createElement(A.tag);if(z){z.appendChild(y)}r(y);o(y,A.attributes);if(A.children){for(var g=0;g<A.children.length;g++){this.createAnEntity(A.children[g],y)}}return y};var d=function(y){var g=AFRAME.$(y);g.parentNode.removeChild(g)};var c=function(z){var y=$$(z);for(var g=0;g<y.length;g++){y[g].parentNode&&y[g].parentNode.removeChild(y[g])}};var p=function(){this.onRemove&&this.onRemove();delete this.onRemove;this.parentNode&&this.parentNode.removeChild(this)};var o=function(z,g){if(typeof g=="function"){g=g()}if(g){for(var y in g){z.setAttribute(y,g[y]||"")}}};var b=function(z){if(!z||!z.conf){return}if(!this.hasLoaded){return this.addEventListener("loaded",function(){b.bind(this)(z)})}var y=this.sceneEl&&this.sceneEl.systems["afbcAnim"];if(!y){return setTimeout(function(){b.bind(this)(z)},100)}var g=Date.now()+Math.round(10000*Math.random());var A=z.conf;A["currRepeat"+g]=0;AnimRealRun.bind(this)(A,null,g)};var m=function(){if(!this.hasLoaded){return this.addEventListener("loaded",function(){m.bind(this)()})}var g=this.sceneEl&&this.sceneEl.systems["afbcAnim"];if(!g){return setTimeout(function(){m.bind(this)()},100)}g.pause(this)};var j=function(){if(!this.hasLoaded){return this.addEventListener("loaded",function(){j.bind(this)()})}var g=this.sceneEl&&this.sceneEl.systems["afbcAnim"];if(!g){return setTimeout(function(){j.bind(this)()},100)}g.resume(this)};var r=function(g){g.addAnEntity=a.bind(g);g.addEntities=u.bind(g);g.createAnEntity=t.bind(g);g.removeAnEntity=d.bind(g);g.removeEntities=c.bind(g);g.removeMe=p.bind(g);g.setAttributes=function(y){o(g,y)};g.animRun=b.bind(g);g.animPause=m.bind(g);g.animResume=j.bind(g);return g};AFRAME.extScenes={};AFRAME.extCurrScene=null;AFRAME.createAScene=function(g){AFRAME.extScenes[g.id]=g;return this};AFRAME.loadScene=function(g){if(this.extCurrScene){this.extCurrScene.removeMe()}var z=document.createElement("a-scene");r(z);var B=this.extScenes[g];if(!B){return console.error("No scene: "+g)}document.body.appendChild(z);if(B.onRemove){z.onRemove=B.onRemove.bind(B)}this.extCurrScene=z;var y=B.attributes||{};if(typeof y=="function"){y=y()}y.id=g;o(z,y);z.addAnEntity("a-assets",{id:"assets"});z.assets=new f("#assets");var A=B.assets||{};if(typeof A=="function"){A=A()}z.assets.addList(A);z.addEntities(B.children);if(B.onInit){B.onInit.bind(B)(z)}z.assets.load(function(){var C=function(){B.onLoaded&&B.onLoaded.bind(B)(z)}.bind(this);if(z.hasLoaded){C()}else{z.addEventListener("loaded",C)}},B.onLoading&&B.onLoading.bind(B))};var s=function(y,g,A){if(!A){return}var z=function(){y.removeEventListener(y._eventName,z);delete y._eventName;var B=A;A=null;B()};if(g=="script"){return y.onload=function(){delete y.onload;var B=A;A=null;B()}}if(g=="img"){y._eventName="load"}else{if(g=="audio"||g=="video"){y._eventName="loadeddata"}else{y._eventName="loaded"}}y.addEventListener(y._eventName,z)};var f=function(g){this.id=g;this.list={}};f.prototype.add=function(){var A=n.apply(n,arguments);if(!A.attributes.crossorigin){A.attributes.crossorigin="anonymous"}var g=A.tag;var y=$(this.id);var z=y.addAnEntity(A);this.list[g]=z;return this};f.prototype.addList=function(z){if(!z){return}if(Array.isArray(z)){for(var y=0;y<z.length;y++){this.add(z[y])}}else{for(var g in z){this.add(g,z[g])}}return this};f.prototype.load=function(y,D){var C=this.list;this.list={};var z=0;for(var B in C){z++}if(z<1){return y&&y()}var A=x(z,function(){y&&y()},D);for(var g in C){s(C[g],g,A)}return this};AFRAME.registerComponent("f-click-to-scene",{schema:{scene:{type:"string"}},init:function(){this.el.addEventListener("click",this.loadScene.bind(this))},loadScene:function(){AFRAME.loadScene(this.data.scene)},remove:function(){this.el.removeEventListener("click",this.loadScene.bind(this))}});document.addEventListener("DOMContentLoaded",function(){document.removeEventListener("DOMContentLoaded",arguments.callee,false);var g=document.body.getAttribute("scene");if(g){AFRAME.loadScene(g)}},false);AFRAME.registerSystem("afbcAnim",{init:function(){this.list=[]},addAnim:function(g,y,z){this.list.push({idx:g,anim:y,target:z})},removeAnim:function(g){for(var y=0;y<this.list.length;y++){if(this.list[y].idx==g){this.list.splice(y,1)}}},removeAnimByTarget:function(g){for(i=this.list.length-1;i>-1;i--){if(this.list[i].target==g){this.list.splice(i,1)}}},pause:function(g){g.isAnimPause=true;for(i=this.list.length-1;i>-1;i--){if(this.list[i].target==g){this.list[i].anim.pause()}}},resume:function(g){g.isAnimPause=false;for(i=this.list.length-1;i>-1;i--){if(this.list[i].target==g){this.list[i].anim.play()}}},tick:(function(){var g;return function(y){if(this.list.length){for(g=this.list.length-1;g>-1;g--){if(this.list[g].target.isAnimPause){return}this.list[g].anim.tick(y)}}}})(),});var v=function(){this.conf=null};AFRAME.anim=function(){return new v()};var w=function(g){if(Math.abs(g.x)<Number.EPSILON){g.x=0}if(Math.abs(g.y)<Number.EPSILON){g.y=0}if(Math.abs(g.z)<Number.EPSILON){g.z=0}};AnimRealRun=function(E,A,F){if(E._repeat>-1&&E["currRepeat"+F]>=E._repeat){delete E["currRepeat"+F];delete E["_from"+F];delete E["_to"+F];return A&&A()}var D=AnimRealRun.bind(this);var g=this.sceneEl.systems["afbcAnim"];E["currRepeat"+F]++;switch(E.type){case"sequence":if(typeof E["sequenceIdx"+F]=="undefined"){E["sequenceIdx"+F]=0}var C=E._sequence[E["sequenceIdx"+F]];E["sequenceIdx"+F]++;if(C){E["currRepeat"+F]--;C["currRepeat"+F]=0;D(C,function(){D(E,A,F)},F)}else{E["sequenceIdx"+F]=0;D(E,A,F)}break;case"spawn":if(E._spawn.length<1){return D(E,A,F)}var J=x(E._spawn.length,function(){D(E,A,F)});for(var B=0;B<E._spawn.length;B++){E._spawn[B]["currRepeat"+F]=0;D(E._spawn[B],J,F)}break;case"cb":E.cb&&E.cb.bind(E.taget)();D(E,A,F);break;case"delay":setTimeout(function(){D(E,A,F)},E._delay);break;case"fadeOut":case"fadeIn":case"fadeTo":var I=Date.now()+Math.round(10000*Math.random());var y=E.getConfig();var z=(this.object3DMap&&this.object3DMap.mesh&&this.object3DMap.mesh.material)||(this.components&&this.components.material&&this.components.material.material);if(!z){return A&&A()}if(Array.isArray(z)){z.forEach(function(L){L.transparent=true})}else{z.transparent=true}var H,G;if(E._reverse&&E["currRepeat"+F]%2==0){G=E["_from"+F];H=E["_to"+F]}else{H=E.from;G=E.to;if(typeof H=="undefined"){H=Array.isArray(z)?z[0].opacity:z.opacity}}y.opacity=[H,G];E["_from"+F]=H;E["_to"+F]=G;y.targets=z;y.complete=function(){g.removeAnim(I);D(E,A,F)};g.addAnim(I,AFRAME.ANIME(y),this);break;case"move":case"moveTo":case"moveBy":var I=Date.now()+Math.round(10000*Math.random());var y=E.getConfig();var K=this.object3D&&this.object3D.position;if(!K){return A&&A()}var H,G;if(E._reverse&&E["currRepeat"+F]%2==0){G=E["_from"+F];H=E["_to"+F]}else{H=E.from&&new THREE.Vector3().copy(E.from);G=E.to&&new THREE.Vector3().copy(E.to);if(!H){H=new THREE.Vector3().copy(K)}if(!G){G=new THREE.Vector3().copy(K).add(E.by)}}w(H);w(G);y.x=[H.x,G.x];y.y=[H.y,G.y];y.z=[H.z,G.z];E["_from"+F]=H;E["_to"+F]=G;y.targets=K;y.complete=function(){g.removeAnim(I);D(E,A,F)};g.addAnim(I,AFRAME.ANIME(y),this);break;case"scale":case"scaleTo":case"scaleBy":var I=Date.now()+Math.round(10000*Math.random());var y=E.getConfig();var K=this.object3D&&this.object3D.scale;if(!K){return A&&A()}var H,G;if(E._reverse&&E["currRepeat"+F]%2==0){G=E["_from"+F];H=E["_to"+F]}else{H=E.from&&new THREE.Vector3().copy(E.from);G=E.to&&new THREE.Vector3().copy(E.to);if(!H){H=new THREE.Vector3().copy(K)}if(!G){G=new THREE.Vector3().copy(K).add(E.by)}}w(H);w(G);y.x=[H.x,G.x];y.y=[H.y,G.y];y.z=[H.z,G.z];E["_from"+F]=H;E["_to"+F]=G;y.targets=K;y.complete=function(){g.removeAnim(I);D(E,A,F)};g.addAnim(I,AFRAME.ANIME(y),this);break;case"rotation":case"rotationTo":case"rotationBy":var I=Date.now()+Math.round(10000*Math.random());var y=E.getConfig();var K=this.object3D&&this.object3D.rotation;if(!K){return A&&A()}var H,G;if(E._reverse&&E["currRepeat"+F]%2==0){G=E["_from"+F];H=E["_to"+F]}else{H=E.from&&new THREE.Vector3().copy(E.from);G=E.to&&new THREE.Vector3().copy(E.to);if(!H){H=new THREE.Vector3().copy(K)}if(!G){G=new THREE.Vector3().copy(K).add(E.by)}}w(H);w(G);y.x=[H.x,G.x];y.y=[H.y,G.y];y.z=[H.z,G.z];E["_from"+F]=H;E["_to"+F]=G;y.targets=K;y.complete=function(){g.removeAnim(I);D(E,A,F)};g.addAnim(I,AFRAME.ANIME(y),this);break;case"color":case"colorTo":case"colorBy":var I=Date.now()+Math.round(10000*Math.random());var y=E.getConfig();var z=(this.object3DMap&&this.object3DMap.mesh&&this.object3DMap.mesh.material)||(this.components&&this.components.material&&this.components.material.material);if(!z){return A&&A()}var K=[];if(Array.isArray(z)){z.forEach(function(L){K.push(L.color)})}else{K.push(z.color)}var H,G;if(E._reverse&&E["currRepeat"+F]%2==0){G=E["_from"+F];H=E["_to"+F]}else{H=E.from&&new THREE.Color().copy(E.from);G=E.to&&new THREE.Color().copy(E.to);if(!H){H=new THREE.Color().copy(K[0])}if(!G){G=new THREE.Color().copy(K[0]).add(E.by)}}y.r=[H.r,G.r];y.g=[H.g,G.g];y.b=[H.b,G.b];E["_from"+F]=H;E["_to"+F]=G;y.targets=K;y.complete=function(){g.removeAnim(I);D(E,A,F)};g.addAnim(I,AFRAME.ANIME(y),this);break}};v.prototype.fadeOut=function(g){return this.conf=new k().setDuration(g).setFrom(1).setTo(0).setType("fadeOut")};v.prototype.fadeIn=function(g){return this.conf=new k().setDuration(g).setFrom(0).setTo(1).setType("fadeIn")};v.prototype.fadeTo=function(y,g){return this.conf=new k().setDuration(y).setTo(g).setType("fadeTo")};v.prototype.move=function(g,z,y){return this.conf=new k().setDuration(g).setFrom(z).setTo(y).setType("move")};v.prototype.moveTo=function(g,y){return this.conf=new k().setDuration(g).setTo(y).setType("moveTo")};v.prototype.moveBy=function(g,y){return this.conf=new k().setDuration(g).setBy(y).setType("moveBy")};v.prototype.scale=function(g,z,y){return this.conf=new k().setDuration(g).setFrom(z).setTo(y).setType("scale")};v.prototype.scaleTo=function(g,y){return this.conf=new k().setDuration(g).setTo(y).setType("scaleTo")};v.prototype.scaleBy=function(g,y){return this.conf=new k().setDuration(g).setBy(y).setType("scaleBy")};var l=Math.PI/180;v.prototype.rotation=function(g,z,y){z={x:z.x*l,y:z.y*l,z:z.z*l};y={x:y.x*l,y:y.y*l,z:y.z*l};return this.conf=new k().setDuration(g).setFrom(z).setTo(y).setType("rotation")};v.prototype.rotationTo=function(g,y){y={x:y.x*l,y:y.y*l,z:y.z*l};return this.conf=new k().setDuration(g).setTo(y).setType("rotationTo")};v.prototype.rotationBy=function(g,y){y={x:y.x*l,y:y.y*l,z:y.z*l};return this.conf=new k().setDuration(g).setBy(y).setType("rotationBy")};var e=function(g){if(typeof g!="object"){return new THREE.Color(g)}return{r:g.r/255,g:g.g/255,b:g.b/255}};v.prototype.color=function(g,z,y){z=e(z);y=e(y);return this.conf=new k().setDuration(g).setFrom(z).setTo(y).setType("color")};v.prototype.colorTo=function(g,y){y=e(y);return this.conf=new k().setDuration(g).setTo(y).setType("colorTo")};v.prototype.colorBy=function(g,y){y=e(y);return this.conf=new k().setDuration(g).setBy(y).setType("colorBy")};v.prototype.cb=function(g,y){return this.conf=new k().setCb(g,y).setType("cb")};v.prototype.delay=function(g){return this.conf=new k().delay(g).setType("delay")};v.prototype.sequence=function(){return this.conf=new k().sequence(arguments).setType("sequence")};v.prototype.spawn=function(){return this.conf=new k().spawn(arguments).setType("spawn")};var k=function(){this._repeat=1};k.prototype.getConfig=function(){var g={autoplay:false,direction:"normal",duration:1000,easing:"linear",elasticity:400,loop:0,round:false,};for(var y in g){if(typeof this["_"+y]!="undefined"){g[y]=this["_"+y]}}return g};k.prototype.setType=function(g){this.type=g;return this};k.prototype.setDuration=function(g){this._duration=parseInt(g);return this};k.prototype.setFrom=function(g){this.from=g;return this};k.prototype.setTo=function(g){this.to=g;return this};k.prototype.setBy=function(g){this.by=g;return this};k.prototype.setCb=function(g,y){this.cb=g;this.taget=y;return this};k.prototype.delay=function(g){this._delay=g;return this};k.prototype.reverse=function(g){this._reverse=true;return this};k.prototype.sequence=function(z){var g=this._sequence=[];for(var y=0;y<z.length;y++){g.push(z[y])}return this};k.prototype.spawn=function(z){var g=this._spawn=[];for(var y=0;y<z.length;y++){g.push(z[y])}return this};k.prototype.repeat=function(g){this._repeat=g;return this};k.prototype.repeatForever=function(){this._repeat=-1;return this};["linear","easeInQuad","easeOutQuad","easeInOutQuad","easeInCubic","easeOutCubic","easeInOutCubic","easeInQuart","easeOutQuart","easeInOutQuart","easeInQuint","easeOutQuint","easeInOutQuint","easeInSine","easeOutSine","easeInOutSine","easeInExpo","easeOutExpo","easeInOutExpo","easeInCirc","easeOutCirc","easeInOutCirc","easeInBack","easeOutBack","easeInOutBack","easeInElastic","easeOutElastic","easeInOutElastic"].forEach(function(g){k.prototype[g]=function(){this._easing=g;return this}})})(window);